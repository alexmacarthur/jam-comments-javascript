---
import pkg from "@jam-comments/server-utilities";
import nodeFetch from "node-fetch";
const { markupFetcher, logError } = pkg;

export interface Props {
  path: string;
}

declare global {
  interface Window {
    JamComments: {
      initialize: () => void;
    };
  }
}

const CLIENT_SCRIPT_URL =
  "https://unpkg.com/@jam-comments/client@2.0.0-beta.2/dist/index.umd.js";
const fetchMarkup = markupFetcher("astro", nodeFetch as any);
const fetchCommentData = async (pagePath: string) => {
  try {
    return await fetchMarkup({
      path: pagePath,
      domain: import.meta.env.JAM_COMMENTS_DOMAIN,
      apiKey: import.meta.env.JAM_COMMENTS_API_KEY,
      baseUrl: import.meta.env.JAM_COMMENTS_BASE_URL,
      environment: import.meta.env.JAM_COMMENTS_ENVIRONMENT,
    });
  } catch (e) {
    logError(e as string);
    return null;
  }
};

const { path } = Astro.props;
const markup = await fetchCommentData(path);
---

<div set:html={markup} />

<script src={CLIENT_SCRIPT_URL}></script>
<script>
  window.JamComments.initialize();
</script>
